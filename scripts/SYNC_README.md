# 数据同步脚本使用说明

## 功能说明

将本地数据库的数据同步到云数据库，支持全量同步所有表的数据。

## 配置说明

在 `.env` 文件中添加云数据库配置（如果云数据库配置与本地不同）：

```env
# 本地数据库配置（已有）
DB_HOST=localhost
DB_PORT=3333
DB_USER=root
DB_PASSWORD=root123456
DB_NAME=kaoqinyi

# 云数据库配置（新增）
CLOUD_DB_HOST=your-cloud-host.com
CLOUD_DB_PORT=3306
CLOUD_DB_USER=your-cloud-user
CLOUD_DB_PASSWORD=your-cloud-password
CLOUD_DB_NAME=kaoqinyi
```

**注意：**
- 如果云数据库配置与本地相同，可以不添加 `CLOUD_` 前缀的配置
- 如果只添加了部分 `CLOUD_` 配置，未配置的项会使用本地数据库配置

## 使用方法

### 1. 预览模式（推荐先运行）

```bash
pnpm run sync-to-cloud
```

此模式会显示将要同步的信息，但不会实际执行同步。

### 2. 确认同步

```bash
pnpm run sync-to-cloud:confirm
```

此模式会：
- 显示5秒倒计时警告
- 清空云数据库的所有表数据
- 将本地数据同步到云数据库

## 同步的表（按顺序）

1. `departments` - 部门表
2. `employees` - 员工表
3. `attendance_rules` - 考勤规则表
4. `attendance` - 考勤记录表
5. `leave_requests` - 请假申请表

## 注意事项

⚠️ **重要警告：**

1. **数据备份**：同步前请确保已备份云数据库数据
2. **数据覆盖**：同步会清空云数据库的所有表数据，然后插入本地数据
3. **表结构**：如果云数据库表不存在，会自动创建（使用本地表结构）
4. **外键约束**：同步时会临时禁用外键检查，确保数据完整性
5. **字符集**：自动处理 UTF-8 字符集，确保中文数据正确同步

## 同步流程

1. 连接本地数据库
2. 连接云数据库
3. 按顺序同步每个表：
   - 获取本地表结构和数据
   - 确保云数据库表存在（不存在则创建）
   - 清空云数据库表数据
   - 批量插入本地数据到云数据库
4. 显示同步结果

## 错误处理

如果同步过程中出现错误：
- 脚本会显示详细的错误信息
- 已同步的表数据不会回滚
- 可以重新运行脚本继续同步

## 示例输出

```
🚀 开始数据同步...

📊 本地数据库: localhost:3333/kaoqinyi
☁️  云数据库: your-cloud-host.com:3306/kaoqinyi

✅ 本地数据库连接成功
✅ 云数据库连接成功

📋 同步表: departments
   从本地读取数据...
   读取到 5 条记录
   清空云数据库表...
   插入数据到云数据库...
   ✅ 成功插入 5 条记录

📋 同步表: employees
   ...

✅ 数据同步完成！
   共同步 5 个表

🔌 本地数据库连接已关闭
🔌 云数据库连接已关闭
```
